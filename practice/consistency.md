Redis 和 MySQL 的一致性如何保证？

定义一些讨论问题的前提：
- MySQL 相对 Redis 来讲，数据可靠性强很多，简化讨论，认为 MySQL 是可靠的（不会丢失数据），Redis 是不可靠的（会丢失数据）
- MySQL 读比写快很多

## 更新缓存和删除缓存

有两种更新数据库之后对缓存的操作，更新和删除。

更新缓存，MySQL 是关系型数据库，Redis 不是关系型数据库，操作数据上存在差异，例如：

MySQL 表 `Student` 有字段姓名 `name` 和年龄 `age`，对应 Redis `hash` 结构，里面存储了姓名、年龄 => 值的映射。

现在根据 id 更新学生和姓名，MySQL 一条 `update` 语句搞定，Redis 需要思考如何转换并写入数据。
当前案例中，不能使用两条 `hset` 命令分别设置姓名和年龄，因为可能存在一个写成功一个写失败的情况，所以必须用 `hmset`。

从上面可以略微看出，更新缓存太复杂，容易出错，不推荐。不如删除等待重建，是最方便。

## 先删缓存，后写数据库

这种方式不推荐，一来如果删成功写失败，在 Redis 存储不可靠的前提下，丢失数据风险极大。

二来，存在不一致情况，如下：
- A 删缓存
- B 读缓存，无效，读数据库
- B 写缓存
- A 写数据库

读比写快，极有可能发生。

## 先写数据库，后删缓存

这种方式推荐，先写入数据库极大的保证了数据安全性，缓存丢失无所谓。

虽然，存在不一致情况，如下：
- 缓存失效
- B 读取数据库
- A 写数据库
- A 写缓存
- B 写缓存

但这种情况基本不存在，读比写快。A 写入数据库一般很久，B 早已写完缓存，之后 A 会覆盖。

## 最终一致性

上述情况都有可能发生不一致性。对缓存我们增加有效期，失效之后重新从数据库读，可以保证最终一致性。

此外，如果写缓存失败，可以通过重试、丢入消息队列重试的方式解决。
   
## 参考

[双写一致性](https://zhuanlan.zhihu.com/p/48334686)