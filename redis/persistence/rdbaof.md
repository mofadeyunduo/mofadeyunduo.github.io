## RDB

`RDB` 保存流程是：

1. 调用 fork 命令，主进程此时会**卡住**，直到 `fork` 完成
1. 子进程保存数据，写入文件

由于 fork 命令会复制进程，导致**内存变为原来的 2 倍**。

`RDB` 恢复流程**只需要读取** `RDB` 文件。

`RDB` 文件压缩存储，只存储**发起保存时间点**的数据。

## AOF

`AOF` 保存流程是：

1. 记录每次命令，追加到文件中

`AOF` 恢复流程需要把**所有命令计算一次**。

`AOF` 存储频率高，基本可以**不丢失数据**。

## 比较

| 方式 | 速度 | 内存 | 空间 |
|:---:|:---:|:---:|:---:|
| RDB | 读取快，保存慢 | 大 | 小 |
| AOF | 保存快，读取慢 | 小 | 大 | 

## 特殊情况

目前一般都是 `RDB` + `AOF`。因为上述的特点，线上数据使用 `AOF` 作为主要备份，`RDB` 每天定时备份一次。

以下场景需要仔细考虑：

- 使用 `RDB` 备份，如果 Redis **内存特别大**，`fork` 就很慢，并且服务器需要 2 倍现有 Redis 的内存防止 `OOM`
- `AOF` 的频率可以设置一条命令一次，确保数据不丢失，磁盘**读写压力巨大**，并且会**阻塞**，服务的延迟会比较大
- 宕机时，`AOF` 恢复备份**需要一些时间**，数据一般**最新**；`RDB` 可以**立即恢复**，但数据可能**丢失**

## 参考

[Redis Persistence](https://redis.io/topics/persistence)
